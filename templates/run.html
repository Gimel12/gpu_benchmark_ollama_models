<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Run Benchmark</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Ollama GPU Benchmark</a>
      </div>
    </nav>
    <div class="container mt-5">
      <h2>Configure and Run Benchmark</h2>
      <form method="post" class="mt-4">
        {% if models and models|length > 0 %}
        <div class="mb-3">
          <label class="form-label">Select Models to Benchmark</label>
          <div class="row">
            {% for m in models %}
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="selected_models" value="{{ m.name }}" id="model_{{ loop.index0 }}">
                <label class="form-check-label" for="model_{{ loop.index0 }}">
                  <strong>{{ m.name }}</strong> <span class="text-muted">{{ m.description }}</span>
                </label>
              </div>
            </div>
            {% endfor %}
          </div>
          <a href="/models" class="btn btn-link mt-2">Edit models</a>
        </div>
        <div class="mb-3">
          <label for="models" class="form-label">Or enter models (space-separated)</label>
          <input type="text" class="form-control" id="models" name="models" placeholder="llama3:8b phi3:14b">
        </div>
        {% else %}
        <div class="mb-3">
          <label for="models" class="form-label">Models (space-separated)</label>
          <input type="text" class="form-control" id="models" name="models" placeholder="llama3:8b phi3:14b">
        </div>
        <div class="mb-3">
          <a href="/models" class="btn btn-link">Create or edit models.json</a>
        </div>
        {% endif %}
        <div class="mb-3">
          <label for="prompt" class="form-label">Prompt</label>
          <input type="text" class="form-control" id="prompt" name="prompt" placeholder="Write an essay about the USA revolution.">
        </div>
        <div class="mb-3">
          <label for="gpus" class="form-label">GPUs (indices, space-separated)</label>
          <input type="text" class="form-control" id="gpus" name="gpus" placeholder="0 1">
        </div>
        <div class="mb-3">
          <label for="runs" class="form-label">Runs per model per GPU</label>
          <input type="number" class="form-control" id="runs" name="runs" value="1" min="1">
        </div>
        <div class="mb-3">
          <label for="api_host" class="form-label">Ollama API Host</label>
          <input type="text" class="form-control" id="api_host" name="api_host" placeholder="http://localhost:11434">
        </div>
        <button id="runBtn" type="submit" class="btn btn-success">Run Benchmark</button>
        <button id="stopBtn" type="button" class="btn btn-danger ms-2" style="display:none;">Stop Benchmark</button>
        <div id="spinnerBox" class="mt-3" style="display:none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Running...</span>
          </div>
          <span class="ms-2">Benchmark is running...</span>
        </div>
      </form>
    </div>
    <script>
      const form = document.querySelector('form');
      const runBtn = document.getElementById('runBtn');
      const stopBtn = document.getElementById('stopBtn');
      const spinnerBox = document.getElementById('spinnerBox');
      let running = false;
      form.addEventListener('submit', function(e) {
        runBtn.disabled = true;
        spinnerBox.style.display = '';
        stopBtn.style.display = '';
        running = true;
      });
      stopBtn.addEventListener('click', function() {
        fetch('/stop', {method: 'POST'})
          .then(() => {
            spinnerBox.style.display = 'none';
            stopBtn.style.display = 'none';
            runBtn.disabled = false;
            running = false;
            alert('Benchmark stopped.');
            window.location.href = '/results';
          })
          .catch(() => {
            alert('Failed to stop benchmark.');
          });
      });
    </script>
  </body>
</html>
