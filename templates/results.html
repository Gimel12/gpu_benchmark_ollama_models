<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Benchmark Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark app-navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">BIZON GPU Benchmark</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/run">Run Benchmark</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/results">Results</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/history">History</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/chat">Chat</a>
            </li>
          </ul>
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="https://bizon-tech.com/?utm_source=gpu-benchmark&utm_medium=app&utm_campaign=navbar-deals" target="_blank" rel="noopener">
                <span class="badge bg-warning text-dark">Deals</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
      <h2>Benchmark Results {% if history %}(History View){% endif %}</h2>
      {% if results %}
        <div class="btn-toolbar mb-3 align-items-center justify-content-between">
          <div class="btn-group me-2">
            {% if not history %}
            <a href="/download" class="btn btn-primary">Download JSON</a>
            <a href="/export_csv/current" class="btn btn-success">Export CSV</a>
            {% else %}
            <a href="/export_csv/{{ history_file }}" class="btn btn-success">Export CSV</a>
            {% endif %}
          </div>
          
          {% if not history %}
          <div class="btn-group">
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#saveHistoryModal">
              Save to History
            </button>
          </div>
          {% endif %}
          <div class="btn-group">
            <button id="summaryViewBtn" type="button" class="btn btn-outline-secondary active">Summary</button>
            <button id="detailedViewBtn" type="button" class="btn btn-outline-secondary">Detailed</button>
          </div>
        </div>
        <!-- Summary (grouped) table -->
        <div id="summaryContainer" class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Model</th>
                <th>GPU</th>
                <th>GPU Name</th>
                <th>Runs</th>
                <th>Avg TPS</th>
                <th>Min TPS</th>
                <th>Max TPS</th>
                <th>Avg Duration (s)</th>
                <th>Avg Temp (°C)</th>
                <th>Avg Util (%)</th>
                <th>Avg Mem (GiB)</th>
                <th>Avg Power (W)</th>
              </tr>
            </thead>
            <tbody id="summaryTbody"></tbody>
          </table>
        </div>

        <!-- Detailed (per-run) table -->
        <div id="detailedContainer" class="table-responsive" style="display:none;">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Model</th>
                <th>GPU</th>
                <th>GPU Name</th>
                <th>Tokens/sec</th>
                <th>Tokens Generated</th>
                <th>Duration (s)</th>
                <th>Prompt</th>
                <th>Avg Temp (°C)</th>
                <th>Avg Util (%)</th>
                <th>Avg Mem (GiB)</th>
                <th>Avg Power (W)</th>
                <th>Max Power (W) (TDP)</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody id="detailedTbody">
              {% for r in results %}
              <tr>
                <td>{{ r.model }}</td>
                <td>
                  {% if r.multi_gpu %}
                    <span class="badge bg-info">Multi-GPU: {{ r.gpu_idx }}</span>
                  {% else %}
                    {{ r.gpu_idx }}
                  {% endif %}
                </td>
                <td>{{ r.gpu_avg_metrics.gpu_name if r.gpu_avg_metrics and r.gpu_avg_metrics.gpu_name else '' }}</td>
                <td>{{ r.tokens_per_second|round(2) if r.tokens_per_second else '' }}</td>
                <td>{{ r.tokens_generated if r.tokens_generated is defined else 'N/A' }}</td>
                <td>{{ r.total_duration_seconds|round(2) }}</td>
                <td>{{ r.prompt }}</td>
                <td>{{ r.gpu_avg_metrics.avg_temperature_c|round(1) if r.gpu_avg_metrics and r.gpu_avg_metrics.avg_temperature_c else '' }}</td>
                <td>{{ r.gpu_avg_metrics.avg_utilization_percent|round(1) if r.gpu_avg_metrics and r.gpu_avg_metrics.avg_utilization_percent else '' }}</td>
                <td>
                  {% if r.gpu_avg_metrics and r.gpu_avg_metrics.avg_memory_used_mib %}
                    {{ (r.gpu_avg_metrics.avg_memory_used_mib / 1024)|round(2) }}
                  {% else %}
                    
                  {% endif %}
                </td>
                <td>{{ r.gpu_avg_metrics.avg_power_draw_w|round(1) if r.gpu_avg_metrics and r.gpu_avg_metrics.avg_power_draw_w else '' }}</td>
                <td>{{ r.gpu_avg_metrics.power_limit_w if r.gpu_avg_metrics is defined and r.gpu_avg_metrics.power_limit_w is defined else 'N/A' }}</td>
                <td>{{ r.timestamp|format_timestamp }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- Chart Navigation Tabs -->
        <div class="mt-4">
          <ul class="nav nav-tabs" id="chartTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">Performance</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="temperature-tab" data-bs-toggle="tab" data-bs-target="#temperature" type="button" role="tab">Temperature</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="utilization-tab" data-bs-toggle="tab" data-bs-target="#utilization" type="button" role="tab">Utilization</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory" type="button" role="tab">Memory</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="power-tab" data-bs-toggle="tab" data-bs-target="#power" type="button" role="tab">Power</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab">Comparison</button>
            </li>
          </ul>
          
          <!-- Tab Content -->
          <div class="tab-content p-3 border border-top-0 rounded-bottom" id="chartTabsContent">
            <!-- Performance Chart -->
            <div class="tab-pane fade show active" id="performance" role="tabpanel">
              <canvas id="tpsChart" height="300"></canvas>
            </div>
            
            <!-- Temperature Chart -->
            <div class="tab-pane fade" id="temperature" role="tabpanel">
              <canvas id="tempChart" height="300"></canvas>
            </div>
            
            <!-- Utilization Chart -->
            <div class="tab-pane fade" id="utilization" role="tabpanel">
              <canvas id="utilizationChart" height="300"></canvas>
            </div>
            
            <!-- Memory Chart -->
            <div class="tab-pane fade" id="memory" role="tabpanel">
              <canvas id="memoryChart" height="300"></canvas>
            </div>
            
            <!-- Power Chart -->
            <div class="tab-pane fade" id="power" role="tabpanel">
              <canvas id="powerChart" height="300"></canvas>
            </div>
            
            <!-- Comparison Chart -->
            <div class="tab-pane fade" id="comparison" role="tabpanel">
              <div class="row mb-3">
                <div class="col-md-6">
                  <select id="comparisonMetric" class="form-select">
                    <option value="tokens_per_second">Tokens/sec</option>
                    <option value="total_duration_seconds">Duration (s)</option>
                    <option value="temperature">Temperature (°C)</option>
                    <option value="utilization">Utilization (%)</option>
                    <option value="memory">Memory Used (GiB)</option>
                    <option value="power">Power Draw (W)</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <select id="comparisonGroup" class="form-select">
                    <option value="model">Group by Model</option>
                    <option value="gpu">Group by GPU</option>
                  </select>
                </div>
              </div>
              <canvas id="comparisonChart" height="300"></canvas>
            </div>
          </div>
        </div>
        
        <script>
          // Parse the results data
          var chartResultsJson = '{{ results|tojson|safe }}';
          var chartResults = JSON.parse(chartResultsJson);

          // View toggle logic
          const summaryBtn = document.getElementById('summaryViewBtn');
          const detailedBtn = document.getElementById('detailedViewBtn');
          const summaryContainer = document.getElementById('summaryContainer');
          const detailedContainer = document.getElementById('detailedContainer');

          function setView(view) {
            if (view === 'summary') {
              summaryContainer.style.display = '';
              detailedContainer.style.display = 'none';
              summaryBtn.classList.add('active');
              detailedBtn.classList.remove('active');
            } else {
              summaryContainer.style.display = 'none';
              detailedContainer.style.display = '';
              summaryBtn.classList.remove('active');
              detailedBtn.classList.add('active');
            }
          }

          summaryBtn.addEventListener('click', function(){ setView('summary'); });
          detailedBtn.addEventListener('click', function(){ setView('detailed'); });

          // Group by Model + GPU and compute aggregates
          function safeNum(v) { return (v === null || v === undefined) ? null : Number(v); }
          function addAgg(agg, key, val){ if(val!==null && !isNaN(val)){ agg[key].push(val);} }
          function avg(arr){ return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null; }
          function min(arr){ return arr.length ? Math.min(...arr) : null; }
          function max(arr){ return arr.length ? Math.max(...arr) : null; }

          const groups = {};
          chartResults.forEach(r => {
            const gpuLabel = r.multi_gpu ? `Multi: ${r.gpu_idx}` : (r.gpu_idx === null ? 'CPU' : String(r.gpu_idx));
            const key = `${r.model}__${gpuLabel}`;
            if(!groups[key]){
              groups[key] = {
                model: r.model,
                gpu: gpuLabel,
                gpu_name: r.gpu_avg_metrics && r.gpu_avg_metrics.gpu_name ? r.gpu_avg_metrics.gpu_name : '',
                tps: [], dur: [], temp: [], util: [], mem_gib: [], power: [], runs: 0
              };
            }
            const g = groups[key];
            g.runs += 1;
            addAgg(g, 'tps', safeNum(r.tokens_per_second));
            addAgg(g, 'dur', safeNum(r.total_duration_seconds));
            if(r.gpu_avg_metrics){
              addAgg(g, 'temp', safeNum(r.gpu_avg_metrics.avg_temperature_c));
              addAgg(g, 'util', safeNum(r.gpu_avg_metrics.avg_utilization_percent));
              // convert MiB -> GiB for summary
              if (r.gpu_avg_metrics.avg_memory_used_mib !== undefined && r.gpu_avg_metrics.avg_memory_used_mib !== null){
                addAgg(g, 'mem_gib', safeNum(r.gpu_avg_metrics.avg_memory_used_mib) / 1024.0);
              }
              addAgg(g, 'power', safeNum(r.gpu_avg_metrics.avg_power_draw_w));
            }
          });

          // Render summary table
          const summaryTbody = document.getElementById('summaryTbody');
          summaryTbody.innerHTML = '';
          Object.values(groups).forEach(g => {
            const row = document.createElement('tr');
            function fmt(v, d=2){ return (v===null||isNaN(v)) ? '' : Number(v).toFixed(d); }
            const cells = [
              g.model,
              g.gpu,
              g.gpu_name,
              g.runs,
              fmt(avg(g.tps)),
              fmt(min(g.tps)),
              fmt(max(g.tps)),
              fmt(avg(g.dur)),
              fmt(avg(g.temp),1),
              fmt(avg(g.util),1),
              fmt(avg(g.mem_gib),2),
              fmt(avg(g.power),1)
            ];
            cells.forEach((c,i)=>{
              const td = document.createElement('td');
              td.textContent = c;
              row.appendChild(td);
            });
            summaryTbody.appendChild(row);
          });

          // Default to Summary view initially
          setView('summary');
          
          // Helper function to generate labels
          function generateLabels(results) {
            var labels = [];
            for (var i = 0; i < results.length; i++) {
              var r = results[i];
              labels.push(r.model + ' (GPU ' + (r.gpu_idx !== null ? r.gpu_idx : 'CPU') + ')');
            }
            return labels;
          }
          
          // Helper function to extract GPU metrics safely
          function getGpuMetric(result, metricName) {
            if (!result.gpu_avg_metrics) return null;
            
            switch(metricName) {
              case 'temperature':
                return result.gpu_avg_metrics.avg_temperature_c;
              case 'utilization':
                return result.gpu_avg_metrics.avg_utilization_percent;
              case 'memory':
                if (result.gpu_avg_metrics.avg_memory_used_mib != null) {
                  return result.gpu_avg_metrics.avg_memory_used_mib / 1024.0; // GiB
                }
                return null;
              case 'power':
                return result.gpu_avg_metrics.avg_power_draw_w;
              default:
                return null;
            }
          }
          
          // Performance Chart (Tokens/sec)
          var perfCtx = document.getElementById('tpsChart').getContext('2d');
          var perfLabels = generateLabels(chartResults);
          var perfData = chartResults.map(function(r) { return r.tokens_per_second; });
          
          new Chart(perfCtx, {
            type: 'bar',
            data: {
              labels: perfLabels,
              datasets: [{
                label: 'Tokens/sec',
                data: perfData,
                backgroundColor: 'rgba(54, 162, 235, 0.7)'
              }]
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: 'Performance (Tokens/sec)'
                }
              }
            }
          });
          
          // Lazy-init charts for tabs that start hidden to avoid zero-size rendering
          var tempChart = null, utilChart = null, memChart = null, powerChart = null;
          function ensureTempChart(){
            if (tempChart) { tempChart.resize(); return; }
            var tempCtx = document.getElementById('tempChart').getContext('2d');
            var tempData = chartResults.map(function(r) { return getGpuMetric(r, 'temperature'); });
            tempChart = new Chart(tempCtx, {
              type: 'bar',
              data: { labels: perfLabels, datasets: [{ label: 'Temperature (°C)', data: tempData, backgroundColor: 'rgba(255, 99, 132, 0.7)' }] },
              options: { responsive: true, plugins: { title: { display: true, text: 'GPU Temperature (°C)' } } }
            });
          }
          function ensureUtilChart(){
            if (utilChart) { utilChart.resize(); return; }
            var utilCtx = document.getElementById('utilizationChart').getContext('2d');
            var utilData = chartResults.map(function(r) { return getGpuMetric(r, 'utilization'); });
            utilChart = new Chart(utilCtx, {
              type: 'bar',
              data: { labels: perfLabels, datasets: [{ label: 'Utilization (%)', data: utilData, backgroundColor: 'rgba(255, 205, 86, 0.7)' }] },
              options: { responsive: true, plugins: { title: { display: true, text: 'GPU Utilization (%)' } } }
            });
          }
          function ensureMemChart(){
            if (memChart) { memChart.resize(); return; }
            var memCtx = document.getElementById('memoryChart').getContext('2d');
            var memData = chartResults.map(function(r) { return getGpuMetric(r, 'memory'); });
            memChart = new Chart(memCtx, {
              type: 'bar',
              data: { labels: perfLabels, datasets: [{ label: 'Memory Used (GiB)', data: memData, backgroundColor: 'rgba(75, 192, 192, 0.7)' }] },
              options: { responsive: true, plugins: { title: { display: true, text: 'GPU Memory Used (GiB)' } } }
            });
          }
          function ensurePowerChart(){
            if (powerChart) { powerChart.resize(); return; }
            var powerCtx = document.getElementById('powerChart').getContext('2d');
            var powerData = chartResults.map(function(r) { return getGpuMetric(r, 'power'); });
            powerChart = new Chart(powerCtx, {
              type: 'bar',
              data: { labels: perfLabels, datasets: [{ label: 'Power Draw (W)', data: powerData, backgroundColor: 'rgba(153, 102, 255, 0.7)' }] },
              options: { responsive: true, plugins: { title: { display: true, text: 'GPU Power Draw (W)' } } }
            });
          }

          // Create the currently visible Performance chart immediately (already created above)
          // Initialize others on tab show
          var chartTabsEl = document.getElementById('chartTabs');
          chartTabsEl.addEventListener('shown.bs.tab', function (event) {
            var target = event.target.getAttribute('data-bs-target');
            switch(target){
              case '#temperature': ensureTempChart(); break;
              case '#utilization': ensureUtilChart(); break;
              case '#memory': ensureMemChart(); break;
              case '#power': ensurePowerChart(); break;
            }
          });
          
          // Comparison Chart (dynamic based on selection)
          var comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
          var comparisonChart = null;
          
          function updateComparisonChart() {
            var metric = document.getElementById('comparisonMetric').value;
            var groupBy = document.getElementById('comparisonGroup').value;
            
            // Group data by model or GPU
            var groupedData = {};
            var datasets = [];
            var allLabels = new Set();
            
            chartResults.forEach(function(result) {
              var groupKey = groupBy === 'model' ? result.model : 'GPU ' + (result.gpu_idx !== null ? result.gpu_idx : 'CPU');
              var label = groupBy === 'model' ? 'GPU ' + (result.gpu_idx !== null ? result.gpu_idx : 'CPU') : result.model;
              
              if (!groupedData[groupKey]) {
                groupedData[groupKey] = { label: groupKey, data: {} };
              }
              
              var value;
              switch(metric) {
                case 'tokens_per_second':
                  value = result.tokens_per_second;
                  break;
                case 'total_duration_seconds':
                  value = result.total_duration_seconds;
                  break;
                case 'temperature':
                  value = getGpuMetric(result, 'temperature');
                  break;
                case 'utilization':
                  value = getGpuMetric(result, 'utilization');
                  break;
                case 'memory':
                  value = getGpuMetric(result, 'memory');
                  break;
                case 'power':
                  value = getGpuMetric(result, 'power');
                  break;
              }
              
              groupedData[groupKey].data[label] = value;
              allLabels.add(label);
            });
            
            // Convert to Chart.js format
            var labels = Array.from(allLabels);
            var colorIndex = 0;
            var colors = [
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 99, 132, 0.7)',
              'rgba(255, 205, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)',
              'rgba(201, 203, 207, 0.7)'
            ];
            
            Object.values(groupedData).forEach(function(group) {
              var dataPoints = labels.map(function(label) {
                return group.data[label] || null;
              });
              
              datasets.push({
                label: group.label,
                data: dataPoints,
                backgroundColor: colors[colorIndex % colors.length],
                borderColor: colors[colorIndex % colors.length].replace('0.7', '1'),
                borderWidth: 1
              });
              
              colorIndex++;
            });
            
            // Get metric display name
            var metricDisplayName;
            switch(metric) {
              case 'tokens_per_second':
                metricDisplayName = 'Tokens/sec';
                break;
              case 'total_duration_seconds':
                metricDisplayName = 'Duration (s)';
                break;
              case 'temperature':
                metricDisplayName = 'Temperature (°C)';
                break;
              case 'utilization':
                metricDisplayName = 'Utilization (%)';
                break;
              case 'memory':
                metricDisplayName = 'Memory Used (GiB)';
                break;
              case 'power':
                metricDisplayName = 'Power Draw (W)';
                break;
            }
            
            // Destroy previous chart if exists
            if (comparisonChart) {
              comparisonChart.destroy();
            }
            
            // Create new chart
            comparisonChart = new Chart(comparisonCtx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: datasets
              },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: metricDisplayName + ' Comparison'
                  }
                }
              }
            });
          }
          
          // Initialize comparison chart
          updateComparisonChart();
          
          // Update comparison chart when selections change
          document.getElementById('comparisonMetric').addEventListener('change', updateComparisonChart);
          document.getElementById('comparisonGroup').addEventListener('change', updateComparisonChart);
        </script>
      {% else %}
        <div class="alert alert-warning">No results to display.</div>
      {% endif %}
    </div>
    
    <!-- Save to History Modal -->
    {% if not history %}
    <div class="modal fade" id="saveHistoryModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Save to History</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Give these benchmark results a name (optional):</p>
            <input type="text" id="historyName" class="form-control" placeholder="e.g., Llama3 8B Benchmark">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveHistoryBtn">Save</button>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      document.getElementById('saveHistoryBtn').addEventListener('click', function() {
        const name = document.getElementById('historyName').value;
        const formData = new FormData();
        formData.append('name', name);
        
        fetch('/save_results', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Results saved to history!');
            window.location.href = '/history';
          } else {
            alert('Error: ' + (data.error || 'Failed to save results'));
          }
        })
        .catch(error => {
          alert('Error saving results: ' + error);
        });
      });
    </script>
    {% endif %}
  <script src="{{ url_for('static', filename='promo.js') }}"></script>
  </body>
</html>
