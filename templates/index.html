<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BIZON GPU Benchmark</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark app-navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">BIZON GPU Benchmark</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/run">Run Benchmark</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/results">Results</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/history">History</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
      <div class="text-center hero">
        <h1 class="display-4">Welcome to the BIZON GPU Benchmark Tool</h1>
        <p class="lead">Benchmark LLM models and analyze GPU performance with ease.</p>
        <button id="runWizardBtn" class="btn btn-primary btn-lg mt-4">Run a Benchmark</button>
      </div>
    </div>

    <!-- How-to video placeholder -->
    <div class="container mt-4">
      <div class="card video-card mx-auto" style="max-width: 960px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"></h5>
          </div>
          <div class="video-embed">
            <iframe src="https://www.youtube.com/embed/SKkwldd_LiM?rel=0" title="BIZON GPU Benchmark - How To" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
        </div>
      </div>
    </div>
    
    <footer class="app-footer mt-5 py-4">
      <div class="container text-center text-muted small">
        BIZON-TECH copyright 2025
      </div>
    </footer>

    <!-- Ollama Setup Modal -->
    <div class="modal fade" id="setupModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Preparing Your Environment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex gap-3 align-items-center mb-3">
              <span class="badge bg-secondary" id="badgeInstalled">Ollama: checking…</span>
              <span class="badge bg-secondary" id="badgeAPI">API: checking…</span>
            </div>
            <div class="small text-muted mb-2">We will install Ollama if needed using: curl -fsSL https://ollama.com/install.sh | sh</div>
            <div id="sudoAlert" class="alert alert-warning d-none" role="alert">
              <div class="fw-semibold mb-1">Installer needs your sudo password.</div>
              <div class="mb-2">Enter your system password and click <span class="fw-semibold">Run with sudo</span> to continue the installation.</div>
              <div class="row g-2 align-items-center mb-2">
                <div class="col-sm-6">
                  <input id="sudoPassword" type="password" class="form-control" placeholder="Enter sudo password">
                </div>
                <div class="col-auto">
                  <button id="sudoRunBtn" class="btn btn-danger btn-sm" type="button">Run with sudo</button>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button id="retryInstallBtn" class="btn btn-warning btn-sm" type="button">Retry Install</button>
                <button id="retryStartBtn" class="btn btn-outline-warning btn-sm" type="button">Retry Start API</button>
              </div>
            </div>
            <pre id="setupLog" class="bg-light p-3 rounded" style="height: 240px; overflow:auto; white-space:pre-wrap;"></pre>
          </div>
          <div class="modal-footer">
            <button id="cancelSetupBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="continueBtn" type="button" class="btn btn-success" disabled>Continue</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const runBtn = document.getElementById('runWizardBtn');
      const setupModal = new bootstrap.Modal(document.getElementById('setupModal'));
      const logEl = document.getElementById('setupLog');
      const badgeInstalled = document.getElementById('badgeInstalled');
      const badgeAPI = document.getElementById('badgeAPI');
      const continueBtn = document.getElementById('continueBtn');
      const sudoAlert = document.getElementById('sudoAlert');
      const retryInstallBtn = document.getElementById('retryInstallBtn');
      const retryStartBtn = document.getElementById('retryStartBtn');
      const sudoRunBtn = document.getElementById('sudoRunBtn');
      const sudoPassword = document.getElementById('sudoPassword');

      function setBadge(el, text, cls){
        el.className = 'badge ' + cls;
        el.textContent = text;
      }

      function updateContinue(installed, api){
        // Allow continue if API running
        continueBtn.disabled = !api;
      }

      async function checkStatus(){
        const r = await fetch('/ollama/status');
        const j = await r.json();
        if (j.installed){
          setBadge(badgeInstalled, `Ollama: Installed ${j.version || ''}`.trim(), 'bg-success');
        } else {
          setBadge(badgeInstalled, 'Ollama: Not found', 'bg-danger');
        }
        if (j.api){
          setBadge(badgeAPI, 'API: Running', 'bg-success');
        } else {
          setBadge(badgeAPI, 'API: Not responding', 'bg-danger');
        }
        updateContinue(j.installed, j.api);
        return j;
      }

      let progressTimer = null;
      async function startInstall(){
        logEl.textContent += 'Starting Ollama install...\n';
        await fetch('/ollama/install', {method:'POST'});
        progressTimer = setInterval(async ()=>{
          const r = await fetch('/ollama/install_progress');
          const j = await r.json();
          logEl.textContent = j.lines.join('\n');
          logEl.scrollTop = logEl.scrollHeight;
          if (j.installed){
            setBadge(badgeInstalled, 'Ollama: Installed', 'bg-success');
          } else {
            setBadge(badgeInstalled, 'Ollama: Not found', 'bg-danger');
          }
          if (j.api){
            setBadge(badgeAPI, 'API: Running', 'bg-success');
          } else {
            setBadge(badgeAPI, 'API: Not responding', 'bg-danger');
          }
          // show sudo guidance if needed
          if (j.need_sudo){
            sudoAlert.classList.remove('d-none');
          }
          updateContinue(j.installed, j.api);
          if (j.api){
            clearInterval(progressTimer);
          }
        }, 1500);
      }

      async function startInstallWithSudo(){
        // start sudo-based install and then poll progress
        const pwd = sudoPassword?.value || '';
        await fetch('/ollama/install_sudo', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({password: pwd})
        });
        // clear password from field for safety
        if (sudoPassword) sudoPassword.value = '';
        progressTimer && clearInterval(progressTimer);
        progressTimer = setInterval(async ()=>{
          const r = await fetch('/ollama/install_progress');
          const j = await r.json();
          logEl.textContent = j.lines.join('\n');
          logEl.scrollTop = logEl.scrollHeight;
          if (j.installed){
            setBadge(badgeInstalled, 'Ollama: Installed', 'bg-success');
          }
          if (j.api){
            setBadge(badgeAPI, 'API: Running', 'bg-success');
            clearInterval(progressTimer);
          }
          updateContinue(j.installed, j.api);
        }, 1500);
      }

      async function ensureReady(){
        logEl.textContent = '';
        continueBtn.disabled = true;
        setupModal.show();
        const s = await checkStatus();
        if (s.installed && s.api){
          updateContinue(s.installed, s.api);
          return;
        }
        if (s.installed && !s.api){
          logEl.textContent += 'Ollama installed but API not responding. Attempting to start...\n';
          await fetch('/ollama/start', {method:'POST'});
          const again = await checkStatus();
          if (again.api){
            updateContinue(again.installed, again.api);
            return;
          }
        }
        await startInstall();
      }

      runBtn.addEventListener('click', async ()=>{
        await ensureReady();
      });

      continueBtn.addEventListener('click', ()=>{
        window.location.href = '/run';
      });

      retryInstallBtn?.addEventListener('click', async ()=>{
        sudoAlert.classList.add('d-none');
        await startInstall();
      });

      retryStartBtn?.addEventListener('click', async ()=>{
        await fetch('/ollama/start', {method:'POST'});
        await checkStatus();
      });

      sudoRunBtn?.addEventListener('click', async ()=>{
        sudoAlert.classList.remove('d-none');
        await startInstallWithSudo();
      });
    </script>
  </body>
</html>
